###
# Docker Compose override for end-to-end (e2e) tests
#
# Use together with the base `docker-compose.yml` file:
#  docker compose -f docker-compose.yml -f docker-compose.e2e.yml up --build
#
services:
  vault:
    image: hashicorp/vault:1.15
    ports:
      - 8200:8200
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: dev-root
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    command: server -dev -dev-root-token-id=dev-root -dev-listen-address=0.0.0.0:8200

  vault-init:
    image: hashicorp/vault:1.15
    restart: "no"
    depends_on:
      - vault
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: dev-root
    volumes:
      - ./.vault:/vault/bootstrap
    command:
      - /bin/sh
      - -c
      - |
        set -e
        until vault status >/dev/null 2>&1; do
          sleep 1
        done
        vault secrets enable -path=secrets kv-v2 >/dev/null 2>&1 || true
        vault secrets enable transit >/dev/null 2>&1 || true
        vault write -f transit/keys/warp-end-to-end >/dev/null 2>&1 || true
        vault kv put secrets/warp consul-address=http://localhost:8500 consul-token=local-dev s3-secret-access-key=local-dev >/dev/null 2>&1 || true
        cat <<'EOF' >/tmp/warp-e2e-policy.hcl
        path "secrets/data/warp" {
          capabilities = ["read"]
        }

        path "secrets/metadata/warp" {
          capabilities = ["read"]
        }

        path "transit/encrypt/warp-end-to-end" {
          capabilities = ["update"]
        }

        path "transit/decrypt/warp-end-to-end" {
          capabilities = ["update"]
        }

        path "transit/keys/warp-end-to-end" {
          capabilities = ["read"]
        }
        EOF
        vault policy write warp-e2e /tmp/warp-e2e-policy.hcl >/dev/null 2>&1 || true
        mkdir -p /vault/bootstrap
        vault token create -policy=warp-e2e -display-name=warp-e2e -orphan -ttl=720h -field token | tee /vault/bootstrap/warp-e2e.token >/dev/null
        echo "Generated warp-e2e token written to /vault/bootstrap/warp-e2e.token"

  s3mock:
    image: adobe/s3mock:latest
    ports:
      - 9090:9090
    environment:
      - initialBuckets=warp-e2e
